---
import Card from './ui/Card.astro';
import Button from './ui/Button.astro';
import { getTranslations, type SupportedLang } from '../lib/i18n';
import { generateEmailLink, fillPlaceholders } from '../lib/mailto';
import type { Recipient, Template } from '../types';

interface Props {
  recipient: Recipient;
  template: Template;
  senderCountry?: string;
  lang?: SupportedLang;
}

const { recipient, template, senderCountry = 'the United States', lang = 'en' } = Astro.props;
const i18n = getTranslations(lang);

/** Fill placeholders with recipient data */
const placeholders: Record<string, string> = {
  recipientName: recipient.name,
  senderCountry,
};

const filledSubject = fillPlaceholders(template.subject, placeholders);
const filledBody = fillPlaceholders(template.body, placeholders);

/** Generate mailto link */
const mailtoLink = generateEmailLink(
  recipient.email,
  template.subject,
  template.body,
  placeholders
);

/** Format body for preview (preserve line breaks) */
const previewBody = filledBody;
---

<Card variant="elevated" padding="lg" class="bg-surface/80 backdrop-blur">
  <!-- Header -->
  <div class="flex items-center justify-between mb-md pb-sm border-b border-white/10">
    <h3 class="text-lg font-semibold text-text">
      {i18n.actions.preview}
    </h3>
    <div class="flex items-center gap-sm text-sm text-text/60">
      <span>To: {recipient.email}</span>
    </div>
  </div>

  <!-- Subject Line -->
  <div class="mb-md">
    <label class="text-xs text-text/50 uppercase tracking-wide mb-xs block">
      Subject
    </label>
    <p class="text-text font-medium bg-bg/50 p-sm rounded-sm">
      {filledSubject}
    </p>
  </div>

  <!-- Email Body Preview -->
  <div class="mb-lg">
    <label class="text-xs text-text/50 uppercase tracking-wide mb-xs block">
      Message
    </label>
    <div class="bg-bg/50 p-md rounded-sm max-h-64 overflow-y-auto">
      <pre class="text-sm text-text/90 whitespace-pre-wrap font-sans">{previewBody}</pre>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="flex flex-col sm:flex-row gap-sm">
    <Button 
      href={mailtoLink} 
      variant="primary"
      class="flex-1 justify-center gap-sm"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
      </svg>
      {i18n.actions.send}
    </Button>
    
    <button
      type="button"
      class="copy-btn flex-1 inline-flex items-center justify-center gap-sm min-h-[44px] px-lg py-sm rounded-sm font-medium transition-all duration-200 bg-surface text-text border border-white/20 hover:bg-white/10 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-white"
      data-copy-subject={filledSubject}
      data-copy-body={filledBody}
      data-copy-to={recipient.email}
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 copy-icon" viewBox="0 0 20 20" fill="currentColor">
        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
      </svg>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 check-icon hidden" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
      </svg>
      <span class="copy-text">{i18n.actions.copy}</span>
    </button>
  </div>
</Card>

<script>
  const copyButtons = document.querySelectorAll('.copy-btn');
  
  copyButtons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const subject = btn.getAttribute('data-copy-subject') || '';
      const body = btn.getAttribute('data-copy-body') || '';
      const to = btn.getAttribute('data-copy-to') || '';
      
      const fullText = `To: ${to}\nSubject: ${subject}\n\n${body}`;
      
      try {
        await navigator.clipboard.writeText(fullText);
        
        const copyIcon = btn.querySelector('.copy-icon');
        const checkIcon = btn.querySelector('.check-icon');
        const copyText = btn.querySelector('.copy-text');
        
        copyIcon?.classList.add('hidden');
        checkIcon?.classList.remove('hidden');
        if (copyText) copyText.textContent = 'Copied!';
        
        setTimeout(() => {
          copyIcon?.classList.remove('hidden');
          checkIcon?.classList.add('hidden');
          if (copyText) copyText.textContent = 'Copy to Clipboard';
        }, 2000);
      } catch {
        console.error('Failed to copy');
      }
    });
  });
</script>

