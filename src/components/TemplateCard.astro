---
import Card from './ui/Card.astro';
import { getTranslations, type SupportedLang } from '../lib/i18n';
import type { Template } from '../types';

interface Props {
  template: Template;
  selected?: boolean;
  lang?: SupportedLang;
}

const { template, selected = false, lang = 'en' } = Astro.props;
const i18n = getTranslations(lang);

/** Type badge styling */
const typeBadgeStyles: Record<string, { bg: string; text: string; border: string }> = {
  urgent: { bg: 'bg-urgent/20', text: 'text-urgent', border: 'border-urgent/30' },
  awareness: { bg: 'bg-sky-500/20', text: 'text-sky-400', border: 'border-sky-500/30' },
  action: { bg: 'bg-emerald-500/20', text: 'text-emerald-400', border: 'border-emerald-500/30' },
  sanctions: { bg: 'bg-amber-500/20', text: 'text-amber-400', border: 'border-amber-500/30' },
};

const typeStyle = typeBadgeStyles[template.type] || typeBadgeStyles.awareness;
const typeLabel = i18n.templates[template.type as keyof typeof i18n.templates] || template.type;
const sourceCount = template.sources.length;
const variationCount = template.variations.length + 1; // +1 for the main template
const selectedClass = selected ? 'ring-2 ring-primary ring-offset-2 ring-offset-bg' : '';

/** Truncate body preview */
const bodyPreview = template.body.slice(0, 150).replace(/\n/g, ' ') + (template.body.length > 150 ? '...' : '');
---

<Card 
  variant="bordered" 
  padding="md"
  class={`cursor-pointer hover:border-primary/50 group ${selectedClass}`}
  data-template-id={template.id}
>
  <!-- Header -->
  <div class="flex items-center gap-sm flex-wrap mb-sm">
    <!-- Type Badge -->
    <span class={`text-xs font-medium px-sm py-[2px] rounded-xs border ${typeStyle.bg} ${typeStyle.text} ${typeStyle.border}`}>
      {template.type === 'urgent' && <span class="animate-pulse mr-[4px]">‚óè</span>}
      {typeLabel}
    </span>
    
    <!-- Metadata Badges -->
    <span class="text-xs text-text/50 flex items-center gap-[4px]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" />
      </svg>
      {sourceCount} {sourceCount === 1 ? 'source' : 'sources'}
    </span>
    <span class="text-xs text-text/50 flex items-center gap-[4px]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z" />
      </svg>
      {variationCount} variations
    </span>
  </div>

  <!-- Subject Preview -->
  <h3 class="font-semibold text-text group-hover:text-primary transition-colors mb-xs line-clamp-2">
    {template.subject}
  </h3>

  <!-- Body Preview (Expandable) -->
  <details class="group/details">
    <summary class="text-sm text-text/60 cursor-pointer hover:text-text/80 list-none flex items-center gap-xs">
      <span class="truncate">{bodyPreview}</span>
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 transition-transform group-open/details:rotate-180" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </summary>
    <div class="mt-sm p-sm bg-bg/50 rounded-sm text-sm text-text/70 whitespace-pre-wrap max-h-48 overflow-y-auto">
      {template.body}
    </div>
  </details>

  <!-- Sources (shown on expand) -->
  <details class="mt-sm">
    <summary class="text-xs text-text/50 cursor-pointer hover:text-text/70 list-none flex items-center gap-xs">
      View sources
      <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
      </svg>
    </summary>
    <ul class="mt-xs space-y-xs">
      {template.sources.map((source) => (
        <li class="text-xs">
          <a 
            href={source.url} 
            target="_blank" 
            rel="noopener noreferrer"
            class="text-primary/80 hover:text-primary underline"
          >
            {source.name}
          </a>
        </li>
      ))}
    </ul>
  </details>
</Card>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>

