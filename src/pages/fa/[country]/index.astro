---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import WizardProgress from '../../../components/WizardProgress.astro';
import CategorySelector from '../../../islands/CategorySelector.tsx';
import Button from '../../../components/ui/Button.astro';
import Card from '../../../components/ui/Card.astro';
import { getTranslations, type SupportedLang } from '../../../lib/i18n';
import { getCategoryCounts, countryCodes, allCategories } from '../../../lib/data';
import type { CountryCode, RecipientCategory } from '../../../types';

export function getStaticPaths() {
  return countryCodes.map((country) => ({
    params: { country },
  }));
}

interface Props {
  country: CountryCode;
}

const { country } = Astro.params as Props;
const lang: SupportedLang = 'fa';
const i18n = getTranslations(lang);

const countryName = i18n.countries[country as keyof typeof i18n.countries] || country;
const categoryCounts = await getCategoryCounts(country);
const totalRecipients = Object.values(categoryCounts).reduce((a, b) => a + b, 0);
const baseUrl = `/${lang}`;

const categoryIcons: Record<RecipientCategory, string> = {
  journalist: 'ğŸ“°', media: 'ğŸ“º', government: 'ğŸ›ï¸', mp: 'ğŸ—³ï¸'
};

const categoryData = allCategories.map((cat: RecipientCategory) => ({
  id: cat,
  label: i18n.categories[cat as keyof typeof i18n.categories] || cat,
  description: i18n.categories[`${cat}Desc` as keyof typeof i18n.categories] || '',
  icon: categoryIcons[cat],
  count: categoryCounts[cat],
}));

const labels = {
  selectCategories: i18n.wizard.selectCategories || 'Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒâ€ŒÙ‡Ø§',
  categoriesSelected: i18n.wizard.categoriesSelected || 'Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡',
  continue: i18n.actions.next || 'Ø§Ø¯Ø§Ù…Ù‡',
  selectAtLeastOne: i18n.wizard.selectAtLeastOne || 'Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯',
};
---

<BaseLayout title={countryName} lang={lang} currentPath={`/fa/${country}`}>
  <div class="max-w-4xl mx-auto">
    <WizardProgress currentStep="category" lang={lang} country={country} />

    <!-- Header -->
    <div class="text-center mb-lg">
      <Button href="/fa" variant="secondary" class="mb-md text-sm">
        {i18n.actions.back} â†
      </Button>
      <h1 class="text-3xl md:text-4xl font-bold text-text mb-sm">
        {countryName}
      </h1>
      <p class="text-xl text-text/70 mb-xs">
        {i18n.wizard.selectCategories}
      </p>
      <p class="text-text/50">
        {i18n.wizard.categoryDescMulti} â€¢ {totalRecipients} {i18n.wizard.recipientsInCategory}
      </p>
    </div>

    <!-- Category Selector -->
    <CategorySelector
      client:load
      categories={categoryData}
      country={country}
      baseUrl={baseUrl}
      labels={labels}
    />

    <!-- Quick tips -->
    <Card variant="bordered" padding="md" class="mt-xl bg-surface/50">
      <h3 class="text-sm font-semibold text-text/70 mb-sm flex items-center gap-xs">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
        </svg>
        {i18n.wizard.tips || 'Ù†Ú©Ø§Øª'}
      </h3>
      <ul class="text-sm text-text/50 space-y-xs">
        <li>â€¢ {i18n.wizard.tipMultiSelect}</li>
        <li>â€¢ {i18n.wizard.tipJournalists}</li>
        <li>â€¢ {i18n.wizard.tipGovernment}</li>
      </ul>
    </Card>
  </div>
</BaseLayout>

