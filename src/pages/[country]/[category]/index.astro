---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import WizardProgress from '../../../components/WizardProgress.astro';
import RecipientSelector from '../../../islands/RecipientSelector.tsx';
import Button from '../../../components/ui/Button.astro';
import { getTranslations, type SupportedLang } from '../../../lib/i18n';
import { getRecipientsByCategories, parseCategories, countryCodes, getAllCategoryCombinations } from '../../../lib/data';
import type { CountryCode, RecipientCategory } from '../../../types';

export function getStaticPaths() {
  const paths: { params: { country: string; category: string } }[] = [];
  const categoryCombinations = getAllCategoryCombinations();

  for (const country of countryCodes) {
    for (const categoryCombo of categoryCombinations) {
      paths.push({ params: { country, category: categoryCombo } });
    }
  }
  return paths;
}

interface Props {
  country: CountryCode;
  category: string; // Can be comma-separated
}

const { country, category } = Astro.params as unknown as Props;
const lang: SupportedLang = 'en';
const i18n = getTranslations(lang);

// Parse categories from URL (supports comma-separated values)
const categories = parseCategories(category);
const countryName = i18n.countries[country as keyof typeof i18n.countries] || country;

// Build category names for display
const categoryNames = categories.map(
  (cat) => i18n.categories[cat as keyof typeof i18n.categories] || cat
);
const categoryDisplayName = categoryNames.join(', ');

// Get recipients from all selected categories
const recipients = await getRecipientsByCategories(country, categories);
const baseUrl = lang === 'en' ? '' : `/${lang}`;
const nextUrl = `${baseUrl}/${country}/${category}/templates`;

// Category labels for badges
const categoryLabels: Record<RecipientCategory, string> = {
  journalist: i18n.categories.journalist,
  media: i18n.categories.media,
  government: i18n.categories.government,
  mp: i18n.categories.mp,
};

const labels = {
  selectAll: i18n.actions.selectAll,
  clearAll: i18n.actions.clearAll,
  selected: i18n.actions.selected,
  search: i18n.actions.search,
  next: i18n.actions.next,
  noResults: i18n.wizard.noRecipients,
  selectAtLeastOne: i18n.actions.selectAtLeastOneRecipient,
  categoryLabels,
};
---

<BaseLayout
  title={`${countryName} - ${categoryDisplayName}`}
  lang={lang}
  currentPath={`/${country}/${category}`}
>
  <div class="max-w-5xl mx-auto">
    <WizardProgress currentStep="recipients" lang={lang} country={country} category={category} />

    <!-- Header -->
    <div class="mb-lg">
      <Button href={`/${country}`} variant="secondary" class="mb-md text-sm">
        ← {i18n.actions.back}
      </Button>
      <h1 class="text-3xl md:text-4xl font-bold text-text mb-xs">
        {i18n.wizard.selectRecipients || 'Select Recipients'}
      </h1>
      <div class="flex flex-wrap gap-xs mb-sm">
        {categories.map((cat) => (
          <span class={`
            inline-flex items-center gap-xs px-sm py-[2px] rounded-full text-xs font-medium
            ${cat === 'journalist' ? 'bg-blue-500/20 text-blue-400 border border-blue-500/30' : ''}
            ${cat === 'media' ? 'bg-purple-500/20 text-purple-400 border border-purple-500/30' : ''}
            ${cat === 'government' ? 'bg-amber-500/20 text-amber-400 border border-amber-500/30' : ''}
            ${cat === 'mp' ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : ''}
          `}>
            {categoryLabels[cat]}
          </span>
        ))}
      </div>
      <p class="text-text/60">
        {countryName} • {recipients.length} {i18n.wizard.recipientsInCategory}
      </p>
    </div>

    {recipients.length > 0 ? (
      <RecipientSelector
        client:load
        recipients={recipients}
        nextUrl={nextUrl}
        labels={labels}
        showCategoryBadges={categories.length > 1}
      />
    ) : (
      <div class="text-center py-xl">
        <p class="text-text/50 mb-md">{i18n.wizard.noRecipients}</p>
        <Button href={`/${country}`} variant="secondary">
          {i18n.actions.back}
        </Button>
      </div>
    )}
  </div>
</BaseLayout>

