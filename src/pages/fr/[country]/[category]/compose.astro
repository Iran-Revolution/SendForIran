---
import BaseLayout from '../../../../layouts/BaseLayout.astro';
import WizardProgress from '../../../../components/WizardProgress.astro';
import ComposeEmail from '../../../../islands/ComposeEmail.tsx';
import { getTranslations, type SupportedLang } from '../../../../lib/i18n';
import { getRecipients, getTemplates, getSenderCountryName, countryCodes, getAllCategoryCombinations } from '../../../../lib/data';
import type { CountryCode } from '../../../../types';

export function getStaticPaths() {
  const paths: { params: { country: string; category: string } }[] = [];
  const categoryCombinations = getAllCategoryCombinations();

  for (const country of countryCodes) {
    for (const categoryCombo of categoryCombinations) {
      paths.push({ params: { country, category: categoryCombo } });
    }
  }
  return paths;
}

interface Props {
  country: CountryCode;
  category: string;
}

const { country, category } = Astro.params as unknown as Props;
const lang: SupportedLang = 'fr';
const i18n = getTranslations(lang);

const countryName = i18n.countries[country as keyof typeof i18n.countries] || country;
const senderCountry = getSenderCountryName(country, lang);

// Load all data - filtering happens client-side based on URL params
const allRecipients = await getRecipients(country);
const allTemplates = await getTemplates(country, 'en');

const labels = {
  send: i18n.actions.send,
  copy: i18n.actions.copy,
  copied: i18n.actions.copied,
  recipientsSummary: i18n.compose.recipientsSummary,
  emailPreview: i18n.compose.emailPreview,
  sendToAll: i18n.compose.sendToAll,
  copyAll: i18n.compose.copyAll,
  subject: 'Objet',
  message: 'Message',
  noRecipients: 'Aucun destinataire sélectionné',
  noTemplate: 'Aucun modèle sélectionné',
  startOver: 'Recommencer',
};

const startOverUrl = `/fr/${country}`;
---

<BaseLayout
  title={`${countryName} - ${i18n.actions.compose}`}
  lang={lang}
  currentPath={`/fr/${country}/${category}/compose`}
>
  <div class="max-w-4xl mx-auto">
    <WizardProgress currentStep="compose" lang={lang} country={country} category={category} />

    <!-- Header -->
    <div class="mb-lg">
      <h1 class="text-3xl md:text-4xl font-bold text-text mb-xs">
        {i18n.actions.compose}
      </h1>
      <p class="text-text/60">
        {countryName}
      </p>
    </div>

    <ComposeEmail
      client:load
      allRecipients={allRecipients}
      allTemplates={allTemplates}
      senderCountry={senderCountry}
      labels={labels}
      startOverUrl={startOverUrl}
    />

    <div id="success-tips" class="hidden mt-xl p-md rounded-md bg-emerald-500/10 border border-emerald-500/30">
      <h3 class="text-sm font-semibold text-emerald-400 mb-sm flex items-center gap-xs">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        Prêt à envoyer !
      </h3>
      <ul class="text-sm text-text/60 space-y-xs">
        <li>• Chaque e-mail est personnalisé avec le nom du destinataire</li>
        <li>• Utilisez « Envoyer à tous » pour ouvrir votre client de messagerie avec tous les destinataires</li>
        <li>• Ou copiez les e-mails individuels et collez-les dans votre application de messagerie préférée</li>
      </ul>
    </div>
  </div>
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const stored = localStorage.getItem('sendforiran_wizard_state');
      if (stored) {
        const state = JSON.parse(stored);
        const hasRecipients = state.recipientIds?.length > 0;
        const hasTemplate = state.templateId;

        if (hasRecipients && hasTemplate) {
          const tips = document.getElementById('success-tips');
          if (tips) tips.classList.remove('hidden');
        }
      }
    } catch {
      // Ignore localStorage errors
    }
  });
</script>

